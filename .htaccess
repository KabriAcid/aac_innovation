RewriteEngine On
RewriteBase /aac_innovation/

# ============================================
# CORS Headers - Apply to all requests
# ============================================
<IfModule mod_headers.c>
    # Set CORS headers for all responses
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
    Header always set Access-Control-Allow-Credentials "true"
    Header always set Access-Control-Max-Age "3600"
    
    # Handle preflight requests
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
</IfModule>

# ============================================
# API Routes - Must come FIRST
# ============================================

# Handle backend API requests - direct access
RewriteCond %{REQUEST_URI} ^/aac_innovation/backend/api/
RewriteRule ^ - [L]

# Alternative: Handle /api/ prefix and route to backend
RewriteCond %{REQUEST_URI} ^/aac_innovation/api/
RewriteRule ^api/(.*)$ backend/api/$1 [L,QSA]

# ============================================
# Frontend Routes - Come AFTER API routes
# ============================================

# Skip rewrite for actual files and directories
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Redirect root to dist folder if it exists
RewriteCond %{REQUEST_URI} ^/aac_innovation/?$
RewriteCond %{DOCUMENT_ROOT}/aac_innovation/dist/index.html -f
RewriteRule ^(.*)$ dist/index.html [L]

# Serve files from dist folder if they exist
RewriteCond %{DOCUMENT_ROOT}/aac_innovation/dist%{REQUEST_URI} -f
RewriteRule ^(.*)$ dist/$1 [L]

# Fallback to index.html for SPA routing (must be last)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{DOCUMENT_ROOT}/aac_innovation/dist/index.html -f
RewriteRule ^ dist/index.html [L]